var startTime=new Date,dvElems=[],dvTypes=[],border=20;function start(){colorBuffer=document.createElement("div"),colorBuffer.style.visibility="hidden",getElems(),createInstances(),cnvSetup(),draw()}function update(){startTime=new Date,updateData(),draw()}function getElems(){allElems=document.getElementsByTagName("*");for(var e=0;e<allElems.length;e++)null!==allElems[e].getAttribute("dv")&&dvElems.push(allElems[e]);allElems=null}function createInstances(){for(i=0;i<dvElems.length;i++)attribs=getAttribData(i),"graph"==attribs[0].replace("type:","")?createType("graph",attribs,dvElems[i]):"piechart"==attribs[0].replace("type:","")?createType("piechart",attribs,dvElems[i]):"histogram"==attribs[0].replace("type:","")?createType("histogram",attribs,dvElems[i]):"points"==attribs[0].replace("type:","")?createType("points",attribs,dvElems[i]):err("Unknown dv-type:",dvTypes[i].type);attribs=null}function updateData(){for(i=0;i<dvElems.length;i++)for(attribs=getAttribData(i),a=0;a<attribs.length;a++)attribs[a].startsWith("data:")&&(dvTypes[i].data=getDataFromStr(attribs[a].replace("data:","")))}function createType(e,t,i){for(dvTypes.push(new dvType(e)),dvTypes[dvTypes.length-1].parent=i,b=1;b<t.length;b++)t[b].startsWith("width:")?dvTypes[dvTypes.length-1].width=parseInt(t[b].replace(/[^\d.-]/g,"")):t[b].startsWith("height:")?dvTypes[dvTypes.length-1].height=parseInt(t[b].replace(/[^\d.-]/g,"")):t[b].startsWith("color:")?dvTypes[dvTypes.length-1].color=t[b].replace("color:",""):t[b].startsWith("data:")?dvTypes[dvTypes.length-1].data=getDataFromStr(t[b].replace("data:","")):dvTypes[dvTypes.length-1].additional.push(t[b]);return void 0!=dvTypes[dvTypes.length-1].type&&void 0!=dvTypes[dvTypes.length-1].width&&void 0!=dvTypes[dvTypes.length-1].height&&void 0!=dvTypes[dvTypes.length-1].color&&void 0!=dvTypes[dvTypes.length-1].data||(err("Info missing! type, width, height, color and data required!  ["+t+"]"),!1)}function cnvSetup(){for(i=0;i<dvTypes.length;i++)dvTypes[i].cnv=document.createElement("canvas"),dvTypes[i].cnv.width=dvTypes[i].width,dvTypes[i].cnv.height=dvTypes[i].height,dvTypes[i].ctx=dvTypes[i].cnv.getContext("2d"),dvTypes[i].ctx.translate(border,border),dvTypes[i].parent.appendChild(dvTypes[i].cnv)}function draw(){for(i=0;i<dvTypes.length;i++)if(ctx=dvTypes[i].ctx,width=dvTypes[i].cnv.width-2*border,height=dvTypes[i].cnv.height-2*border,max_x=dvTypes[i].data.length-1,max_y=Math.max.apply(null,dvTypes[i].data),ctx.font="14px Arial",ctx.clearRect(-border,-border,dvTypes[i].cnv.width,dvTypes[i].cnv.height),"graph"==dvTypes[i].type){if(draw_nodes=!0,draw_text=!0,step_size_x=width/max_x,step_size_y=height/max_y,node_color=dvTypes[i].color,void 0!=dvTypes[i].additional)for(a=0;a<dvTypes[i].additional.length;a++)dvTypes[i].additional[a].startsWith("draw-nodes:")?"false"==dvTypes[i].additional[a].replace("draw-nodes:","")?draw_nodes=!1:"true"==dvTypes[i].additional[a].replace("draw-nodes:","")?draw_nodes=!0:err("Invalid draw-nodes vaule:",dvTypes[i].additional[a].replace("draw-nodes:","")):dvTypes[i].additional[a].startsWith("node-color:")?node_color=dvTypes[i].additional[a].replace("node-color:",""):dvTypes[i].additional[a].startsWith("draw-text:")&&("false"==dvTypes[i].additional[a].replace("draw-text:","")?draw_text=!1:"true"==dvTypes[i].additional[a].replace("draw-text:","")?draw_text=!0:err("Invalid draw-text vaule:",dvTypes[i].additional[a].replace("draw-text:","")));if(ctx.lineCap="round",ctx.lineWidth=1,ctx.beginPath(),ctx.strokeStyle="#bbb",ctx.rect(0,0,width,height),step_size_x>=10)for(x=0;x<=max_x;x++)ctx.moveTo(x*step_size_x,0),ctx.lineTo(x*step_size_x,height);if(step_size_y>=10)for(y=0;y<=max_y;y++)ctx.moveTo(0,y*step_size_y),ctx.lineTo(width,y*step_size_y);for(ctx.stroke(),ctx.beginPath(),ctx.strokeStyle=dvTypes[i].color,ctx.fillStyle=dvTypes[i].color,ctx.fill(),ctx.lineWidth=4,ctx.moveTo(0,height-dvTypes[i].data[0]*step_size_y),x=0;x<=max_x;x++)ctx.lineTo(x*step_size_x,height-dvTypes[i].data[x]*step_size_y);if(ctx.stroke(),ctx.beginPath(),step_size_x>=10&&draw_nodes)for(ctx.fillStyle=node_color,ctx.strokeStyle=node_color,ctx.moveTo(0,height-dvTypes[i].data[0]*step_size_y),x=0;x<=max_x;x++)ctx.moveTo(x*step_size_x,height-dvTypes[i].data[x]*step_size_y),ctx.ellipse(x*step_size_x,height-dvTypes[i].data[x]*step_size_y,2,2,0,0,2*Math.PI);if(draw_text){if(step_size_x>=10)for(x=0;x<=max_x;x++)ctx.fillText(dvTypes[i].data[x],x*step_size_x-ctx.measureText(dvTypes[i].data[x]).width/2,height-dvTypes[i].data[x]*step_size_y-8);if(step_size_x>=20)for(x=0;x<=max_x;x++)ctx.fillText(x+1,x*step_size_x,height+border/2+6)}ctx.stroke(),draw_nodes=null,node_color=null,step_size_x=null,step_size_y=null,draw_text=null}else if("histogram"==dvTypes[i].type){if(draw_text=!0,step_size_x=width/(max_x+1),step_size_y=(height-20)/max_y,fill_color="#fff",void 0!=dvTypes[i].additional)for(a=0;a<dvTypes[i].additional.length;a++)dvTypes[i].additional[a].startsWith("draw-text:")?"false"==dvTypes[i].additional[a].replace("draw-text:","")?draw_text=!1:"true"==dvTypes[i].additional[a].replace("draw-text:","")?draw_text=!0:err("Invalid draw-text vaule:",dvTypes[i].additional[a].replace("draw-text:","")):dvTypes[i].additional[a].startsWith("fill-color:")&&(fill_color=dvTypes[i].additional[a].replace("fill-color:",""));for(sum=dvTypes[i].data.reduce(function(e,t){return parseFloat(e)+parseFloat(t)},0),current=0,smallest=Math.min(width,height)-border,ctx.beginPath(),ctx.lineWidth=1,ctx.strokeStyle="#bbb",ctx.rect(0,0,width,height),ctx.stroke(),ctx.beginPath(),ctx.lineWidth=4,ctx.strokeStyle=dvTypes[i].color,ctx.fillStyle=fill_color,a=0;a<dvTypes[i].data.length;a++)ctx.rect(a*step_size_x,height,step_size_x,-dvTypes[i].data[a]*step_size_y);if(ctx.fill(),ctx.stroke(),ctx.fillStyle="#000",draw_text){if(step_size_x>=10)for(x=0;x<=max_x;x++)ctx.fillText(dvTypes[i].data[x],x*step_size_x,height-dvTypes[i].data[x]*step_size_y-6);if(step_size_x>=20)for(x=0;x<=max_x;x++)ctx.fillText(x+1,x*step_size_x,height+border/2+6)}step_size_x=null,step_size_y=null,draw_text=null,fill_color=null}else if("piechart"==dvTypes[i].type){if(draw_text=!0,min_size=!1,draw_border=!0,fill_color="#fff",void 0!=dvTypes[i].additional)for(a=0;a<dvTypes[i].additional.length;a++)dvTypes[i].additional[a].startsWith("draw-text:")?"false"==dvTypes[i].additional[a].replace("draw-text:","")?draw_text=!1:"true"==dvTypes[i].additional[a].replace("draw-text:","")?draw_text=!0:err("Invalid draw-text vaule:",dvTypes[i].additional[a].replace("draw-text:","")):dvTypes[i].additional[a].startsWith("fill-color:")?fill_color=dvTypes[i].additional[a].replace("fill-color:",""):dvTypes[i].additional[a].startsWith("min-size:")?"false"==dvTypes[i].additional[a].replace("min-size:","")?min_size=!1:"true"==dvTypes[i].additional[a].replace("min-size:","")?min_size=!0:err("Invalid min-size vaule:",dvTypes[i].additional[a].replace("min-size:","")):dvTypes[i].additional[a].startsWith("draw-boder:")&&("false"==dvTypes[i].additional[a].replace("draw-boder:","")?draw_border=!1:"true"==dvTypes[i].additional[a].replace("draw-boder:","")?draw_border=!0:err("Invalid draw-boder vaule:",dvTypes[i].additional[a].replace("draw-boder:","")));for(sum=dvTypes[i].data.reduce(function(e,t){return parseFloat(e)+parseFloat(t)},0),sorted=dvTypes[i].data.slice().sort(function(e,t){return e-t}).reverse(),current=0,smallest=Math.min(width,height)-border,ctx.beginPath(),ctx.lineWidth=1,ctx.strokeStyle="#bbb",ctx.rect(0,0,width,height),ctx.stroke(),ctx.beginPath(),ctx.lineCap="round",ctx.lineWidth=4,ctx.strokeStyle=dvTypes[i].color,ctx.fillStyle=fill_color,a=0;a<dvTypes[i].data.length;a++)current+=2*Math.PI/sum*sorted[a],ctx.arc(width/2,height/2,smallest/2,0,current),ctx.lineTo(width/2,height/2);if(ctx.fill(),ctx.stroke(),draw_text){for(current=0,ctx.beginPath(),ctx.fillStyle="#000",a=0;a<dvTypes[i].data.length;a++)current+=2*Math.PI/sum*sorted[a],min_size?2*Math.PI/sum*sorted[a]>.17&&ctx.fillText(sorted[a],Math.cos(current-2*Math.PI/sum*sorted[a]/2)*smallest/3+width/2,Math.sin(current-2*Math.PI/sum*sorted[a]/2)*smallest/3+height/2):ctx.fillText(sorted[a],Math.cos(current-2*Math.PI/sum*sorted[a]/2)*smallest/3+width/2,Math.sin(current-2*Math.PI/sum*sorted[a]/2)*smallest/3+height/2);ctx.stroke()}}else if("points"==dvTypes[i].type){if(draw_text=!0,point_size=5,step_size_x=width/max_x,step_size_y=height/max_y,void 0!=dvTypes[i].additional)for(a=0;a<dvTypes[i].additional.length;a++)dvTypes[i].additional[a].startsWith("draw-text:")?"false"==dvTypes[i].additional[a].replace("draw-text:","")?draw_text=!1:"true"==dvTypes[i].additional[a].replace("draw-text:","")?draw_text=!0:err("Invalid draw-text vaule:",dvTypes[i].additional[a].replace("draw-text:","")):dvTypes[i].additional[a].startsWith("point-size:")&&(point_size=parseInt(dvTypes[i].additional[a].replace("point-size:","")));if(ctx.lineWidth=1,ctx.beginPath(),ctx.strokeStyle="#bbb",ctx.rect(0,0,width,height),step_size_x>=10)for(x=0;x<=max_x;x++)ctx.moveTo(x*step_size_x,0),ctx.lineTo(x*step_size_x,height);if(step_size_y>=10)for(y=0;y<=max_y;y++)ctx.moveTo(0,y*step_size_y),ctx.lineTo(width,y*step_size_y);for(ctx.stroke(),ctx.beginPath(),ctx.fillStyle=dvTypes[i].color,ctx.moveTo(0,height-dvTypes[i].data[0]*step_size_y),x=0;x<=max_x;x++)ctx.beginPath(),ctx.moveTo(x*step_size_x,height-dvTypes[i].data[x]*step_size_y),ctx.ellipse(x*step_size_x,height-dvTypes[i].data[x]*step_size_y,point_size,point_size,0,0,2*Math.PI),ctx.fill();if(ctx.beginPath(),ctx.fillStyle="#000",draw_text){if(step_size_x>=10)for(offset=-8,point_size>5&&(offset=0),x=0;x<=max_x;x++)ctx.fillText(dvTypes[i].data[x],x*step_size_x-ctx.measureText(dvTypes[i].data[x]).width/2,height-dvTypes[i].data[x]*step_size_y+offset);if(step_size_x>=20)for(x=0;x<=max_x;x++)ctx.fillText(x+1,x*step_size_x,height+border/2+6)}ctx.stroke(),point_size=null,step_size_x=null,step_size_y=null,draw_text=null}ctx=null,width=null,height=null,max_x=null,max_y=null}function getDataFromStr(e){return e.startsWith("[")&&e.endsWith("]")||e.startsWith("{")&&e.endsWith("}")?e.replace("[","").replace("]","").replace("{","").replace("}","").split(","):window[e]}function getAttribData(e){return dvElems[e].getAttribute("dv").toLowerCase().split(" ")}function err(e){console.error("ERROR: "+e)}function dvType(e){this.type=e,this.width,this.height,this.color,this.parent,this.data=[],this.additional=[],this.cnv,this.ctx}window.onload=start();